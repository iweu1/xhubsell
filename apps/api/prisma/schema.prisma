// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  SELLER
  RECRUITER
  CLIENT
}

enum SellerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum BannerPosition {
  HERO
  SIDEBAR
  FOOTER
  HEADER
  POPUP
}

enum NotificationType {
  SYSTEM
  MESSAGE
  REVIEW
  PROMOTION
  BOOKING
  PAYMENT
}

enum Language {
  RU
  EN
}

// Core User Model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  firstName String?
  lastName  String?
  avatar    String?
  role      Role     @default(CLIENT)
  language  Language @default(EN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sellerProfile     SellerProfile?
  sentMessages       Message[]         @relation("SentMessages")
  receivedMessages   Message[]         @relation("ReceivedMessages")
  messageThreads     MessageThread[]
  favorites          Favorite[]
  reviews            Review[]
  notifications      Notification[]
  auditLogs          AuditLog[]
  premiumSubscription PremiumSubscription?

  @@map("users")
}

// Seller Profile
model SellerProfile {
  id          String        @id @default(cuid())
  userId      String        @unique
  title       String
  description String?
  bio         String?
  hourlyRate  Decimal?
  experience  Int?          // years
  location    String?
  languages   String[]      // array of language codes
  skills      String[]      // array of skills
  status      SellerStatus  @default(PENDING_VERIFICATION)
  rating      Decimal?      @default(0) @db.Decimal(3, 2)
  reviewCount Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  statusHistory       SellerStatusHistory[]
  portfolios          Portfolio[]
  services            Service[]
  certificates        Certificate[]
  availabilitySlots   AvailabilitySlot[]
  reviews             Review[]
  categories          SellerCategory[]
  statistics          StatisticsDaily[]
  banners             Banner[]
  announcements       Announcement[]
  promotions          Promotion[]
  favorites           Favorite[]

  @@map("seller_profiles")
}

// Seller Status History
model SellerStatusHistory {
  id        String        @id @default(cuid())
  sellerId  String
  status    SellerStatus
  reason    String?
  changedBy String        // user ID who made the change
  createdAt DateTime      @default(now())

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("seller_status_history")
}

// Portfolio
model Portfolio {
  id          String @id @default(cuid())
  sellerId    String
  title       String
  description String?
  projectUrl  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  images PortfolioImage[]

  @@map("portfolios")
}

// Portfolio Images
model PortfolioImage {
  id         String @id @default(cuid())
  portfolioId String
  url        String
  alt        String?
  order      Int    @default(0)

  // Relations
  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@map("portfolio_images")
}

// Services
model Service {
  id          String  @id @default(cuid())
  sellerId    String
  title       String
  description String?
  price       Decimal
  duration    Int?    // minutes
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("services")
}

// Certificates
model Certificate {
  id         String   @id @default(cuid())
  sellerId   String
  title      String
  issuer     String?
  issueDate  DateTime?
  expiryDate DateTime?
  fileUrl    String?
  createdAt  DateTime @default(now())

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

// Availability Slots
model AvailabilitySlot {
  id        String   @id @default(cuid())
  sellerId  String
  startTime DateTime
  endTime   DateTime
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("availability_slots")
}

// Reviews
model Review {
  id         String   @id @default(cuid())
  sellerId   String
  reviewerId String
  rating     Int      // 1-5
  comment    String?
  createdAt  DateTime @default(now())

  // Relations
  seller   SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  reviewer User          @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

// Categories
model Category {
  id          String   @id @default(cuid())
  nameEn      String
  nameRu      String
  slug        String   @unique
  description String?
  icon        String?  // icon URL or name
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[]       @relation("CategoryHierarchy")
  sellers  SellerCategory[]

  @@map("categories")
}

// Seller Categories (many-to-many relationship)
model SellerCategory {
  id         String   @id @default(cuid())
  sellerId   String
  categoryId String
  createdAt  DateTime @default(now())

  // Relations
  seller   SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([sellerId, categoryId])
  @@map("seller_categories")
}

// Message Threads
model MessageThread {
  id         String   @id @default(cuid())
  subject    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  participants User[]
  messages      Message[]

  @@map("message_threads")
}

// Messages
model Message {
  id         String   @id @default(cuid())
  threadId   String
  senderId   String
  receiverId String
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender   User          @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User          @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Favorites
model Favorite {
  id         String   @id @default(cuid())
  userId     String
  sellerId   String
  createdAt  DateTime @default(now())

  // Relations
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([userId, sellerId])
  @@map("favorites")
}

// Banners
model Banner {
  id        String        @id @default(cuid())
  sellerId  String
  title     String
  imageUrl  String
  linkUrl   String?
  position  BannerPosition
  isActive  Boolean       @default(true)
  startDate DateTime
  endDate   DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("banners")
}

// Announcements
model Announcement {
  id        String   @id @default(cuid())
  sellerId  String
  title     String
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// Promotions
model Promotion {
  id          String   @id @default(cuid())
  sellerId    String
  title       String
  description String
  discount    Int      // percentage
  code        String   @unique
  isActive    Boolean  @default(true)
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("promotions")
}

// Premium Subscriptions
model PremiumSubscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  plan      String
  startDate DateTime
  endDate   DateTime?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("premium_subscriptions")
}

// Daily Statistics
model StatisticsDaily {
  id            String   @id @default(cuid())
  sellerId      String
  date          DateTime @default(now()) @db.Date
  views         Int      @default(0)
  inquiries     Int      @default(0)
  bookings      Int      @default(0)
  revenue       Decimal  @default(0)
  createdAt     DateTime @default(now())

  // Relations
  seller SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([sellerId, date])
  @@map("statistics_daily")
}

// Notifications
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?            // additional data
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Settings
model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Audit Logs
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  resourceId String?
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}